<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Add Delete Button for file attribute page | kencho51</title>
<meta name="keywords" content="factory method, csv migration">
<meta name="description" content="How to add a delete button and pass tests">
<meta name="author" content="Ken Cho">
<link rel="canonical" href="https://gigathing.pages.dev/add-delete-button/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://gigathing.pages.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://gigathing.pages.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gigathing.pages.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://gigathing.pages.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://gigathing.pages.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://gigathing.pages.dev/add-delete-button/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://gigathing.pages.dev/add-delete-button/">
  <meta property="og:site_name" content="kencho51">
  <meta property="og:title" content="Add Delete Button for file attribute page">
  <meta property="og:description" content="How to add a delete button and pass tests">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2021-02-22T12:49:28+08:00">
    <meta property="article:modified_time" content="2021-02-22T12:49:28+08:00">
    <meta property="article:tag" content="Factory Method">
    <meta property="article:tag" content="Csv Migration">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Add Delete Button for file attribute page">
<meta name="twitter:description" content="How to add a delete button and pass tests">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://gigathing.pages.dev/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Add Delete Button for file attribute page",
      "item": "https://gigathing.pages.dev/add-delete-button/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Add Delete Button for file attribute page",
  "name": "Add Delete Button for file attribute page",
  "description": "How to add a delete button and pass tests",
  "keywords": [
    "factory method", "csv migration"
  ],
  "articleBody": "Problem - Add-delete-button-#457 Create Delete button function in the admin file page DatasetLog and CurationLog to log the events.\nPass the unit test and acceptance test.\nHow Create Delete button in /view/adminFile/_form.php \u003ctd\u003e\u003ca role=\"button\" class=\"btn js-delete\" name=\"delete_file_attr\" data=\"\u003c?= $fa-\u003eid ?\u003e\"\u003eDelete\u003c/a\u003e\u003c/td\u003e \u003c/script\u003e $('.js-delete').click(function (e) { e.preventDefault(); id = $(this).attr('data'); row = $('.row-edit-' + id); if (id) { $.post('/adminFile/deleteFileAttribute', { 'id': id }, function(result) { if (result) { // console.log(result); } }, 'json'); } window.location.reload(); }) \u003c/script\u003e Create action deleteFileAttribute in AdminFileController.php public function accessRules() { return array( array('allow', // admin only 'actions'=\u003earray('linkFolder','admin','delete','index','view','create','update','update1', 'editAttr', 'uploadAttr', 'deleteFileAttribute'), 'roles'=\u003earray('admin'), ), array('allow', 'actions' =\u003e array('create1'), 'users' =\u003e array('@'), ), array('allow', // allow all users 'actions' =\u003e array('downloadCount'), 'users'=\u003earray('*'), ), array('deny', // deny all users 'users'=\u003earray('*'), ), ); } /** * Yii's method for routing urls to an action. Override to use custom actions */ public function actions() { return array( 'deleteFileAttribute'=\u003e'application.controllers.adminFile.DeleteFileAttributeAction', ); } Create DeleteFileAttributeAction.php in /controllers/adminFile, because AdminFileController.php is very big, so better be implemented in separate class \u003c?php /** * This action will delete file attributes in admin file update page */ class DeleteFileAttributeAction extends CAction { public function run() { if (!Yii::app()-\u003erequest-\u003eisPostRequest) throw new CHttpException(404, \"The requested page does not exist.\"); if (isset($_POST['id'])) { $attribute = FileAttributes::model()-\u003efindByPk($_POST['id']); if ($attribute) { $out = $attribute-\u003efile-\u003edataset_id; $fileName = $attribute-\u003efile-\u003ename; $fileModel = get_class($attribute); $fileId = $attribute-\u003efile-\u003eid; $modelId = $attribute-\u003eid; $model = Dataset::model()-\u003efindByPk($out); if ($model-\u003eupload_status === \"Published\") { DatasetLog::createDatasetLogEntry($out, $fileName, $fileModel, $modelId, $fileId); } else { CurationLog::createCurationLogEntry($out, $fileName); //Pass in dataset_id returned from File object. } $attribute-\u003edelete(); Yii::app()-\u003eend(); } } } } Factory method in /protected/models/DatasetLog.php to log Published dataset /** * Factory method to call for common attributes * @param int $id * @param string $fileName * @param string $fileModel * @param int $modelId * @param int $fileId * @return DatasetLog */ public static function makeNewInstanceForDatasetLogBy (int $id, string $fileName, string $fileModel, int $modelId, int $fileId): DatasetLog { $datasetlog = new DatasetLog(); $datasetlog-\u003ecreated_at = date(\"Y-m-d H:i:s\"); $datasetlog-\u003edataset_id = $id; $datasetlog-\u003emessage = $fileName; $datasetlog-\u003emodel = $fileModel; $datasetlog-\u003emodel_id = $modelId; $datasetlog-\u003eurl = Yii::app()-\u003ecreateUrl('/adminFile/update', array('id'=\u003e$fileId)); return $datasetlog; } /** * Retrieves attributes and store them in dataset_log table when triggered. * @param int $id * @param string $fileName * @param string $fileModel * @param int $modelId * @param int $fileId * @return bool */ public static function createDatasetLogEntry(int $id, string $fileName, string $fileModel, int $modelId, int $fileId): bool { $datasetlog = self::makeNewInstanceForDatasetLogBy($id, $fileName, $fileModel, $modelId, $fileId); $datasetlog-\u003emessage = $fileName. \": file attribute deleted\"; return $datasetlog-\u003esave(); } Pass the unit test for datasetLog \u003c?php class DatasetLogTest extends CDbTestCase { public function testDataSetLogEntryFactory() { // With reference to the entry in dataset_log fixture $datasetId = 1; $fileName = \"File Tinamus_guttatus.fa.gz\"; $fileModel = \"File\"; $modelId = 16945; $fileId = 16945; //mockup ID $datasetlog = DatasetLog::makeNewInstanceForDatasetLogBy($datasetId, $fileName, $fileModel, $modelId, $fileId); $this-\u003eassertNotNull($datasetlog); $this-\u003eassertTrue(is_a($datasetlog, DatasetLog::class)); $this-\u003eassertEquals($datasetId, $datasetlog-\u003edataset_id); $this-\u003eassertEquals($fileName, $datasetlog-\u003emessage); $this-\u003eassertEquals($fileModel, $datasetlog-\u003emodel); $this-\u003eassertEquals($modelId, $datasetlog-\u003emodel_id); $this-\u003eassertEquals(\"./bin/adminFile/update/id/$fileId\", $datasetlog-\u003eurl); $this-\u003eassertTrue($datasetlog-\u003eisNewRecord); } // Includde Dataset fixture to avoid unique duplicate key value violation with dataset_log_pkey protected $fixtures=array( 'datasets'=\u003e'Dataset', ); public function testCreateDatasetLogEntry() { $datasetId = 1; $fileName = \"File Tinamus_guttatus.fa.gz\"; $fileModel = \"File\"; $modelId = 16945; $fileId = 16945; //mockup ID $saveNewEntry = DatasetLog::createDatasetLogEntry($datasetId, $fileName, $fileModel, $modelId, $fileId); $this-\u003eassertTrue(is_bool($saveNewEntry) === true, \"bool is returned\"); $this-\u003eassertTrue(true===$saveNewEntry, \"No new entry is saved to dataset log table\"); // To assert the delete message will be generated as expected $datasetlog = DatasetLog::model()-\u003efindByPk($datasetId); $this-\u003eassertEquals(\"File Tinamus_guttatus.fa.gz: file attribute deleted\", $datasetlog-\u003emessage, \"Delete message was generated in different format\"); } } Factory method in /protected/models/CurationLog.php to log non Published dataset /** * Factory method to make a new instance and factor out the common code * * @param int $id * @param string $creator * @return CurationLog */ public static function makeNewInstanceForCurationLogBy(int $id, string $creator): CurationLog { $curationlog = new CurationLog(); $curationlog-\u003ecreation_date = date(\"Y-m-d\"); $curationlog-\u003elast_modified_date = null; $curationlog-\u003edataset_id = $id; $curationlog-\u003ecreated_by = $creator; return $curationlog; } public static function createlog($status,$id) { $curationlog = self::makeNewInstanceForCurationLogBy($id, \"System\"); $curationlog-\u003eaction = \"Status changed to \".$status; return $curationlog-\u003esave(); } public static function createlog_assign_curator($id,$creator,$username) { $curationlog = self::makeNewInstanceForCurationLogBy($id, $creator); $curationlog-\u003eaction = \"Curator Assigned\".\" $username\"; return $curationlog-\u003esave(); } /** * Retrieves attributes and store them in curation_log table when triggered * @param $id * @param string $fileName * @return bool */ public static function createCurationLogEntry(int $id, string $fileName): bool { $curationlog = self::makeNewInstanceForCurationLogBy($id, \"System\"); $curationlog-\u003eaction = $fileName.\": file attribute deleted\"; return $curationlog-\u003esave(); } Pass the unit test for CurationLog \u003c?php class CurationLogTest extends CDbTestCase { public function testMakeNewInstance() { $datasetId = 1; $creator = \"System\"; $curationLog = CurationLog::makeNewInstanceForCurationLogBy($datasetId, $creator); $this-\u003eassertNotNull($curationLog); $this-\u003eassertTrue(is_a($curationLog, CurationLog::class)); $this-\u003eassertEquals($datasetId, $curationLog-\u003edataset_id); $this-\u003eassertEquals($creator, $curationLog-\u003ecreated_by); $this-\u003eassertTrue($curationLog-\u003eisNewRecord); } } Create I should see a file attribute table in DatasetViewContext.php /** * @Then I should see a file attribute table */ public function iShouldSeeATable(TableNode $table) { foreach ($table as $row) { PHPUnit_Framework_Assert::assertTrue( $this-\u003eminkContext-\u003egetSession()-\u003egetPage()-\u003ehasContent($row['Attribute Name']) ); PHPUnit_Framework_Assert::assertTrue( $this-\u003eminkContext-\u003egetSession()-\u003egetPage()-\u003ehasContent($row['Value']) ); PHPUnit_Framework_Assert::assertTrue( $this-\u003eminkContext-\u003egetSession()-\u003egetPage()-\u003ehasContent($row['Unit']) ); } } Pass the acceptance test @admin-file @issue-457 Feature: A curator can manage file attributes in admin file update page As a curator, I want to manage file attributes from the update form So that I can associate various attributes to files Background: Given Gigadb web site is loaded with production-like data And an admin user exists @ok Scenario: Guest user cannot visit admin file update page Given I am not logged in to Gigadb web site When I go to \"/adminFile/update/\" Then I should see \"Login\" @ok Scenario: Go to a published dataset found in production-like database Given I am not logged in to Gigadb web site When I go to \"dataset/100056\" And I should see \"Termitomyces sp. J132 fungus genome assembly data.\" And I follow \"History\" Then I should see \"History\" tab with text \"File Termitomyces_assembly_v1.0.fa.gz updated\" And I should see \"History\" tab with text \"File Termitomyces_gene_v1.0.cds.fa updated\" And I should see \"History\" tab with text \"File Termitomyces_gene_v1.0.cds.fa updated\" And I should see \"History\" tab with text \"File Termitomyces_gene_v1.0.gff updated\" And I should see \"History\" tab with text \"File Termitomyces_gene_v1.0.gff updated\" And I should see \"History\" tab with text \"File Termitomyces_gene_v1.0.pep.fa updated\" And I should see \"History\" tab with text \"File Termitomyces_gene_v1.0.pep.fa updated\" @ok @Published Scenario: Sign in as admin and visit admin file update page and see New Attribute, Edit, Delete buttons Given I sign in as an admin When I am on \"/adminFile/update/id/13973\" Then I should see a button \"New Attribute\" And I should see a file attribute table | Attribute Name | Value | Unit | | last_modified | 2013-7-15 | | And I should see a button input \"Edit\" And I should see a button input \"Delete\" @ok @javascript @Published Scenario: Sign in as admin, delete an attribute of a published dataset and check history tab Given I sign in as an admin And I am on \"/adminFile/update/id/13973\" And I should see \"last_modified\" When I press \"Delete\" And I go to \"dataset/100056\" Then I should see \"Termitomyces sp. J132 fungus genome assembly data.\" And I follow \"History\" And I should see \"History\" tab with text \"Termitomyces_assembly_v1.0.fa.gz: file attribute deleted\" @ok @javascript @Published Scenario: Sign in as admin, no delete button should be seen after delete action has been triggered Given I sign in as an admin And I am on \"/adminFile/update/id/13973\" And I should see a file attribute table | Attribute Name | Value | Unit | | last_modified | 2013-7-15 | | And I should see a button input \"Delete\" When I press \"Delete\" And I wait \"3\" seconds Then I should not see \"last_modified\" And I should not see \"2013-7-15\" And I should not see a button \"Delete\" @ok @javascript @NonPublished Scenario: Go to a non published dataset found in production-like database, create then delete a keyword attribute Given I sign in as an admin And I am on \"/adminFile/update/id/95354\" And I should see \"test Bauhinia\" And I press \"Delete\" And I should not see \"test Bauhinia\" #Go to the last page of dataset log When I go to \"datasetLog/admin/DatasetLog_page/74\" Then I should not see \"100245\" And I should not see \"FCHCGJYBBXX-HKBAUpcgEAACRAAPEI-201_L2_2.fq.gz: file attribute added\" And I should not see \"FCHCGJYBBXX-HKBAUpcgEAACRAAPEI-201_L2_2.fq.gz: file attribute deleted\" Learn Tables relationship dataset file file_attribute id id id identifier dataset_id file_id upload_status value 2.1 Update file_attribute table in data/dev/production_like\nid,file_id,attribute_id,value,unit_id 5441,95354,455,test Bauhinia, 2.2 Update the production_like.pgdmp, PR548 ops/scripts/make_pgdmp_production_like.sh\nHints from Rija I must have forgotten what you said 😞 Right now I am working on to pass the curation_log test, here is my scenario:\nBackground: Given Gigadb web site is loaded with production-like data @wip @issue-#457 @javascript Scenario: Go to a non published dataset found in production-like database Given I sign in as an admin And I go to \"/adminFile/update/id/xxx\" And I should see some file attributes When I press \"Delete\" And I should not see file attributes And I go to \"dataset/YYY\" And I follow \"History\" Then I should not see some file attributes But I think the above scenario is not a proper way to test. Because, I could not identify the correct xxx and YYY. And even I found the xxx, this step And I go to \"dataset/YYY\" will not pass as error The dataset does not exist will be found.\nSo, can I have your suggestion on how to pass the curation_log test?\nAmong a dataset’s attributes in the database table there are id, and identifier.\nController actions that alter the dataset expect to have the internal id id as parameter (that’s your xxx) as that’s the most appropriate one to uniquely identify a row in a database table.\nIn /adminFile/update/id/xxx, /id/ is how yii framework knows that we are looking for a dataset whose id attribute is xxx\nidentifier is for the DOI and is the public identifier for the dataset, that’s why it is used in the view as the dataset url is meant to be shared publicly (that’s your yyy).\nSo when you pick a dataset as example, select both attributes from the table.\ngigadb=# select id, identifier, title from dataset; id | identifier | title ... 189 | 100133 | Reference data for phage M13 dsDNA generated with the Oxford Nanopore MinION. 204 | 100143 | Software and supporting material for \"SMAP: a streamlined methylation pipelinefor bisulphite sequencing\". 210 | 100155 | Supporting data for \"Sparse whole-genome sequencing identifies two loci for major depressive disorder\". ... Regarding your second point: datasets that are not published cannot be accessible publicly, so going to the public url /dataset/yyy would result in that error.\nYou’ve got couple of approaches:\nYou could add Given steps to change the upload status temporarily away from published, but then you would need to find a way to revert the change after the test has run.\nOr you could have the Then steps to check this page: (http://gigadb.gigasciencejournal.com:9170/datasetLog/admin/) or more precisely manually navigate to the last page, and use that in a Then step. It’s not the most robust (the last page may change if we add/remove example datasets from production-like), but it’s the easiest.\nA better approach is to use the test database instead of production-like then checking /datasetLog/admin/’s first page would be enough, but you will need some Given steps to add some file attributes first to a dataset as I think the test database doesn’t have any.\nAn improved alternative to that latter pre-condition would be to update the test data for the test database to have some file attributes in it so you don’t have to add extra Given steps (I’ve pasted bash code to do that easily in @pli888’s PR 532, you’d just have to update the corresponding CSV file beforehand)\nReference ",
  "wordCount" : "1895",
  "inLanguage": "en",
  "datePublished": "2021-02-22T12:49:28+08:00",
  "dateModified": "2021-02-22T12:49:28+08:00",
  "author":{
    "@type": "Person",
    "name": "Ken Cho"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://gigathing.pages.dev/add-delete-button/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "kencho51",
    "logo": {
      "@type": "ImageObject",
      "url": "https://gigathing.pages.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://gigathing.pages.dev/" accesskey="h" title="kencho51 (Alt + H)">kencho51</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://gigathing.pages.dev/page/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://gigathing.pages.dev/post" title="Tech">
                    <span>Tech</span>
                </a>
            </li>
            <li>
                <a href="https://gigathing.pages.dev/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="https://gigathing.pages.dev/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://gigathing.pages.dev/">Home</a>&nbsp;»&nbsp;<a href="https://gigathing.pages.dev/post/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Add Delete Button for file attribute page
    </h1>
    <div class="post-description">
      How to add a delete button and pass tests
    </div>
    <div class="post-meta"><span title='2021-02-22 12:49:28 +0800 HKT'>February 22, 2021</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Ken Cho

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#problem---add-delete-button-457" aria-label="Problem - Add-delete-button-#457">Problem - Add-delete-button-#457</a></li>
                <li>
                    <a href="#how" aria-label="How">How</a></li>
                <li>
                    <a href="#learn" aria-label="Learn">Learn</a></li>
                <li>
                    <a href="#hints-from-rija" aria-label="Hints from Rija">Hints from Rija</a></li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="problem---add-delete-button-457">Problem - <a href="https://github.com/gigascience/gigadb-website/pull/503">Add-delete-button-#457</a><a hidden class="anchor" aria-hidden="true" href="#problem---add-delete-button-457">#</a></h3>
<ol>
<li>
<p>Create <code>Delete</code> button function in the <code>admin file page</code>
<img alt="img" loading="lazy" src="/image/delete_button.png"></p>
</li>
<li>
<p><code>DatasetLog</code> and <code>CurationLog</code> to log the events.</p>
</li>
<li>
<p>Pass the <code>unit test</code> and <code>acceptance test</code>.</p>
</li>
</ol>
<h3 id="how">How<a hidden class="anchor" aria-hidden="true" href="#how">#</a></h3>
<ol>
<li>Create <code>Delete</code> button in <code>/view/adminFile/_form.php</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">role</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn js-delete&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;delete_file_attr&#34;</span> <span class="na">data</span><span class="o">=</span><span class="s">&#34;&lt;?= $fa-&gt;id ?&gt;&#34;</span><span class="p">&gt;</span>Delete<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$(&#39;.js-delete&#39;).click(function (e) {
</span></span><span class="line"><span class="cl">    e.preventDefault();
</span></span><span class="line"><span class="cl">    id = $(this).attr(&#39;data&#39;);
</span></span><span class="line"><span class="cl">    row = $(&#39;.row-edit-&#39; + id);
</span></span><span class="line"><span class="cl">    if (id) {
</span></span><span class="line"><span class="cl">        $.post(&#39;/adminFile/deleteFileAttribute&#39;, { &#39;id&#39;: id }, function(result) {
</span></span><span class="line"><span class="cl">            if (result) {
</span></span><span class="line"><span class="cl">                // console.log(result);
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }, &#39;json&#39;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    window.location.reload();
</span></span><span class="line"><span class="cl">})
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>Create action <code>deleteFileAttribute</code> in <code>AdminFileController.php</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">accessRules</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="c1">// admin only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="s1">&#39;actions&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;linkFolder&#39;</span><span class="p">,</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="s1">&#39;view&#39;</span><span class="p">,</span><span class="s1">&#39;create&#39;</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">,</span><span class="s1">&#39;update1&#39;</span><span class="p">,</span> <span class="s1">&#39;editAttr&#39;</span><span class="p">,</span> <span class="s1">&#39;uploadAttr&#39;</span><span class="p">,</span> <span class="s1">&#39;deleteFileAttribute&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;roles&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="s1">&#39;actions&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;create1&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                    <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span>  <span class="c1">// allow all users
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="s1">&#39;actions&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;downloadCount&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="s1">&#39;users&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;deny&#39;</span><span class="p">,</span>  <span class="c1">// deny all users
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="s1">&#39;users&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Yii&#39;s method for routing urls to an action. Override to use custom actions
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">actions</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;deleteFileAttribute&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;application.controllers.adminFile.DeleteFileAttributeAction&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><ol start="3">
<li>Create <code>DeleteFileAttributeAction.php</code> in <code>/controllers/adminFile</code>, because <code>AdminFileController.php</code> is very big, so better be implemented in separate class</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * This action will delete file attributes in admin file update page
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DeleteFileAttributeAction</span> <span class="k">extends</span> <span class="nx">CAction</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPostRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nx">CHttpException</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&#34;The requested page does not exist.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$attribute</span> <span class="o">=</span> <span class="nx">FileAttributes</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findByPk</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$attribute</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$out</span> <span class="o">=</span> <span class="nv">$attribute</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">dataset_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$fileName</span> <span class="o">=</span> <span class="nv">$attribute</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$fileModel</span> <span class="o">=</span> <span class="nx">get_class</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$fileId</span> <span class="o">=</span> <span class="nv">$attribute</span><span class="o">-&gt;</span><span class="na">file</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$modelId</span> <span class="o">=</span> <span class="nv">$attribute</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$model</span> <span class="o">=</span> <span class="nx">Dataset</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findByPk</span><span class="p">(</span><span class="nv">$out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">upload_status</span> <span class="o">===</span> <span class="s2">&#34;Published&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">DatasetLog</span><span class="o">::</span><span class="na">createDatasetLogEntry</span><span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="nv">$fileModel</span><span class="p">,</span> <span class="nv">$modelId</span><span class="p">,</span> <span class="nv">$fileId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">CurationLog</span><span class="o">::</span><span class="na">createCurationLogEntry</span><span class="p">(</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$fileName</span><span class="p">);</span> <span class="c1">//Pass in dataset_id returned from File object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$attribute</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ol start="4">
<li><code>Factory method</code> in <code>/protected/models/DatasetLog.php</code> to log <code>Published</code> dataset</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">  <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Factory method to call for common attributes
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $id
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $fileName
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $fileModel
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $modelId
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $fileId
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return DatasetLog
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">makeNewInstanceForDatasetLogBy</span> <span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$fileModel</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$modelId</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$fileId</span><span class="p">)</span><span class="o">:</span> <span class="nx">DatasetLog</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DatasetLog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">created_at</span> <span class="o">=</span> <span class="nx">date</span><span class="p">(</span><span class="s2">&#34;Y-m-d H:i:s&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">dataset_id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="nv">$fileName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">model</span> <span class="o">=</span> <span class="nv">$fileModel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">model_id</span> <span class="o">=</span> <span class="nv">$modelId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">url</span> <span class="o">=</span> <span class="nx">Yii</span><span class="o">::</span><span class="na">app</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createUrl</span><span class="p">(</span><span class="s1">&#39;/adminFile/update&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="o">=&gt;</span><span class="nv">$fileId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$datasetlog</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Retrieves attributes and store them in dataset_log table when triggered.
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $id
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $fileName
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $fileModel
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $modelId
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $fileId
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return bool
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">createDatasetLogEntry</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$fileModel</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$modelId</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$fileId</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">makeNewInstanceForDatasetLogBy</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="nv">$fileModel</span><span class="p">,</span> <span class="nv">$modelId</span><span class="p">,</span> <span class="nv">$fileId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="nv">$fileName</span><span class="o">.</span> <span class="s2">&#34;: file attribute deleted&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><ol start="5">
<li>Pass the <code>unit test</code> for <code>datasetLog</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DatasetLogTest</span> <span class="k">extends</span> <span class="nx">CDbTestCase</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">testDataSetLogEntryFactory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// With reference to the entry in dataset_log fixture
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$datasetId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileName</span> <span class="o">=</span> <span class="s2">&#34;File Tinamus_guttatus.fa.gz&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileModel</span> <span class="o">=</span> <span class="s2">&#34;File&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$modelId</span> <span class="o">=</span> <span class="mi">16945</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileId</span> <span class="o">=</span> <span class="mi">16945</span><span class="p">;</span> <span class="c1">//mockup ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$datasetlog</span> <span class="o">=</span> <span class="nx">DatasetLog</span><span class="o">::</span><span class="na">makeNewInstanceForDatasetLogBy</span><span class="p">(</span><span class="nv">$datasetId</span><span class="p">,</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="nv">$fileModel</span><span class="p">,</span> <span class="nv">$modelId</span><span class="p">,</span> <span class="nv">$fileId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertNotNull</span><span class="p">(</span><span class="nv">$datasetlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="nv">$datasetlog</span><span class="p">,</span> <span class="nx">DatasetLog</span><span class="o">::</span><span class="na">class</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$datasetId</span><span class="p">,</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">dataset_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$fileName</span><span class="p">,</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$fileModel</span><span class="p">,</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">model</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$modelId</span><span class="p">,</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">model_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&#34;./bin/adminFile/update/id/</span><span class="si">$fileId</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">isNewRecord</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Includde Dataset fixture to avoid unique duplicate key value violation with dataset_log_pkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">protected</span> <span class="nv">$fixtures</span><span class="o">=</span><span class="k">array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;datasets&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;Dataset&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">testCreateDatasetLogEntry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileName</span> <span class="o">=</span> <span class="s2">&#34;File Tinamus_guttatus.fa.gz&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileModel</span> <span class="o">=</span> <span class="s2">&#34;File&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$modelId</span> <span class="o">=</span> <span class="mi">16945</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileId</span> <span class="o">=</span> <span class="mi">16945</span><span class="p">;</span> <span class="c1">//mockup ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$saveNewEntry</span> <span class="o">=</span> <span class="nx">DatasetLog</span><span class="o">::</span><span class="na">createDatasetLogEntry</span><span class="p">(</span><span class="nv">$datasetId</span><span class="p">,</span> <span class="nv">$fileName</span><span class="p">,</span> <span class="nv">$fileModel</span><span class="p">,</span> <span class="nv">$modelId</span><span class="p">,</span> <span class="nv">$fileId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">is_bool</span><span class="p">(</span><span class="nv">$saveNewEntry</span><span class="p">)</span> <span class="o">===</span> <span class="k">true</span><span class="p">,</span> <span class="s2">&#34;bool is returned&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="k">true</span><span class="o">===</span><span class="nv">$saveNewEntry</span><span class="p">,</span> <span class="s2">&#34;No new entry is saved to dataset log table&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// To assert the delete message will be generated as expected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$datasetlog</span> <span class="o">=</span> <span class="nx">DatasetLog</span><span class="o">::</span><span class="na">model</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findByPk</span><span class="p">(</span><span class="nv">$datasetId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&#34;File Tinamus_guttatus.fa.gz: file attribute deleted&#34;</span><span class="p">,</span> <span class="nv">$datasetlog</span><span class="o">-&gt;</span><span class="na">message</span><span class="p">,</span> <span class="s2">&#34;Delete message was generated in different format&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ol start="6">
<li><code>Factory method</code> in <code>/protected/models/CurationLog.php</code> to log <code>non Published</code> dataset</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Factory method to make a new instance and factor out the common code
</span></span></span><span class="line"><span class="cl"><span class="sd">     *
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param int $id
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $creator
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return CurationLog
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">makeNewInstanceForCurationLogBy</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$creator</span><span class="p">)</span><span class="o">:</span> <span class="nx">CurationLog</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CurationLog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">creation_date</span> <span class="o">=</span> <span class="nx">date</span><span class="p">(</span><span class="s2">&#34;Y-m-d&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">last_modified_date</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">dataset_id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">created_by</span> <span class="o">=</span> <span class="nv">$creator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$curationlog</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">createlog</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">makeNewInstanceForCurationLogBy</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="s2">&#34;System&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">action</span> <span class="o">=</span> <span class="s2">&#34;Status changed to &#34;</span><span class="o">.</span><span class="nv">$status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">createlog_assign_curator</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span><span class="nv">$creator</span><span class="p">,</span><span class="nv">$username</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">makeNewInstanceForCurationLogBy</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$creator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">action</span> <span class="o">=</span> <span class="s2">&#34;Curator Assigned&#34;</span><span class="o">.</span><span class="s2">&#34; </span><span class="si">$username</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * Retrieves attributes and store them in curation_log table when triggered
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $id
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param string $fileName
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return bool
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">createCurationLogEntry</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$fileName</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">makeNewInstanceForCurationLogBy</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="s2">&#34;System&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">action</span> <span class="o">=</span> <span class="nv">$fileName</span><span class="o">.</span><span class="s2">&#34;: file attribute deleted&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$curationlog</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><ol start="7">
<li>Pass the <code>unit test</code> for <code>CurationLog</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CurationLogTest</span> <span class="k">extends</span> <span class="nx">CDbTestCase</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">testMakeNewInstance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datasetId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$creator</span> <span class="o">=</span> <span class="s2">&#34;System&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$curationLog</span> <span class="o">=</span> <span class="nx">CurationLog</span><span class="o">::</span><span class="na">makeNewInstanceForCurationLogBy</span><span class="p">(</span><span class="nv">$datasetId</span><span class="p">,</span> <span class="nv">$creator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertNotNull</span><span class="p">(</span><span class="nv">$curationLog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nx">is_a</span><span class="p">(</span><span class="nv">$curationLog</span><span class="p">,</span> <span class="nx">CurationLog</span><span class="o">::</span><span class="na">class</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$datasetId</span><span class="p">,</span> <span class="nv">$curationLog</span><span class="o">-&gt;</span><span class="na">dataset_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="nv">$creator</span><span class="p">,</span> <span class="nv">$curationLog</span><span class="o">-&gt;</span><span class="na">created_by</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$curationLog</span><span class="o">-&gt;</span><span class="na">isNewRecord</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ol start="8">
<li>Create <code>I should see a file attribute table</code> in <code>DatasetViewContext.php</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @Then I should see a file attribute table
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">iShouldSeeATable</span><span class="p">(</span><span class="nx">TableNode</span> <span class="nv">$table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$table</span> <span class="k">as</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">PHPUnit_Framework_Assert</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">minkContext</span><span class="o">-&gt;</span><span class="na">getSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getPage</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasContent</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;Attribute Name&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">PHPUnit_Framework_Assert</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">minkContext</span><span class="o">-&gt;</span><span class="na">getSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getPage</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasContent</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">PHPUnit_Framework_Assert</span><span class="o">::</span><span class="na">assertTrue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">minkContext</span><span class="o">-&gt;</span><span class="na">getSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getPage</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasContent</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;Unit&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><ol start="9">
<li>Pass the <code>acceptance test</code></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gherkin" data-lang="gherkin"><span class="line"><span class="cl"><span class="nt">@admin-file</span><span class="nf"> </span><span class="nt">@issue-457</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  Feature: A curator can manage file attributes in admin file update page
</span></span></span><span class="line"><span class="cl"><span class="nf">    As a curator,
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">I </span><span class="nf">want to manage file attributes from the update form
</span></span></span><span class="line"><span class="cl"><span class="nf">    So that I can associate various attributes to files
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Background:</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">Gigadb web site is loaded with production-like data
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">an admin user exists
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="nt">@ok</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Guest user cannot visit admin file update page
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">I am not logged in to Gigadb web site
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">I go to &#34;</span><span class="s">/adminFile/update/</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">I should see &#34;</span><span class="s">Login</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="nt">@ok</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Go to a published dataset found in production-like database
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">I am not logged in to Gigadb web site
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">I go to &#34;</span><span class="s">dataset/100056</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">Termitomyces sp. J132 fungus genome assembly data.</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I follow &#34;</span><span class="s">History</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_assembly_v1.0.fa.gz updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_gene_v1.0.cds.fa updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_gene_v1.0.cds.fa updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_gene_v1.0.gff updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_gene_v1.0.gff updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_gene_v1.0.pep.fa updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">File Termitomyces_gene_v1.0.pep.fa updated</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="nt">@ok</span><span class="nf"> </span><span class="nt">@Published</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Sign in as admin and visit admin file update page and see New Attribute, Edit, Delete buttons
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">I sign in as an admin
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">I am on &#34;</span><span class="s">/adminFile/update/id/13973</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">I should see a button &#34;</span><span class="s">New Attribute</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see a file attribute table
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">      |</span><span class="s"> Attribute Name</span><span class="k"> |</span><span class="s"> Value</span><span class="k"> |</span><span class="s"> Unit</span><span class="k"> |</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">      |</span><span class="s"> last_modified</span><span class="k">  |</span><span class="s"> 2013-7-15</span><span class="k"> |  |</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see a button input &#34;</span><span class="s">Edit</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see a button input &#34;</span><span class="s">Delete</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="nt">@ok</span><span class="nf"> </span><span class="nt">@javascript</span><span class="nf"> </span><span class="nt">@Published</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Sign in as admin, delete an attribute of a published dataset and check history tab
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">I sign in as an admin
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I am on &#34;</span><span class="s">/adminFile/update/id/13973</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">last_modified</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">I press &#34;</span><span class="s">Delete</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I go to &#34;</span><span class="s">dataset/100056</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">I should see &#34;</span><span class="s">Termitomyces sp. J132 fungus genome assembly data.</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I follow &#34;</span><span class="s">History</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">History</span><span class="nf">&#34; tab with text &#34;</span><span class="s">Termitomyces_assembly_v1.0.fa.gz: file attribute deleted</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="nt">@ok</span><span class="nf"> </span><span class="nt">@javascript</span><span class="nf"> </span><span class="nt">@Published</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Sign in as admin, no delete button should be seen after delete action has been triggered
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">I sign in as an admin
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I am on &#34;</span><span class="s">/adminFile/update/id/13973</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see a file attribute table
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    |</span><span class="s"> Attribute Name</span><span class="k"> |</span><span class="s"> Value</span><span class="k"> |</span><span class="s"> Unit</span><span class="k"> |</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    |</span><span class="s"> last_modified</span><span class="k">  |</span><span class="s"> 2013-7-15</span><span class="k"> |  |</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see a button input &#34;</span><span class="s">Delete</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">I press &#34;</span><span class="s">Delete</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I wait &#34;</span><span class="s">3</span><span class="nf">&#34; seconds
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">I should not see &#34;</span><span class="s">last_modified</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should not see &#34;</span><span class="s">2013-7-15</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should not see a button &#34;</span><span class="s">Delete</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="nt">@ok</span><span class="nf"> </span><span class="nt">@javascript</span><span class="nf"> </span><span class="nt">@NonPublished</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Go to a non published dataset found in production-like database, create then delete a keyword attribute
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">I sign in as an admin
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I am on &#34;</span><span class="s">/adminFile/update/id/95354</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should see &#34;</span><span class="s">test Bauhinia</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I press &#34;</span><span class="s">Delete</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should not see &#34;</span><span class="s">test Bauhinia</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="c">    #Go to the last page of dataset log</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">I go to &#34;</span><span class="s">datasetLog/admin/DatasetLog_page/74</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">I should not see &#34;</span><span class="s">100245</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should not see &#34;</span><span class="s">FCHCGJYBBXX-HKBAUpcgEAACRAAPEI-201_L2_2.fq.gz: file attribute added</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">I should not see &#34;</span><span class="s">FCHCGJYBBXX-HKBAUpcgEAACRAAPEI-201_L2_2.fq.gz: file attribute deleted</span><span class="nf">&#34;
</span></span></span></code></pre></div><h3 id="learn">Learn<a hidden class="anchor" aria-hidden="true" href="#learn">#</a></h3>
<ol>
<li>Tables relationship
<table>
  <thead>
      <tr>
          <th>dataset</th>
          <th>file</th>
          <th>file_attribute</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>id</strong></td>
          <td><del>id</del></td>
          <td>id</td>
      </tr>
      <tr>
          <td>identifier</td>
          <td><strong>dataset_id</strong></td>
          <td><del>file_id</del></td>
      </tr>
      <tr>
          <td>upload_status</td>
          <td></td>
          <td>value</td>
      </tr>
  </tbody>
</table>
</li>
</ol>
<p>2.1 Update file_attribute table in <code>data/dev/production_like</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csv" data-lang="csv"><span class="line"><span class="cl"><span class="s">id</span><span class="p">,</span><span class="s">file_id</span><span class="p">,</span><span class="s">attribute_id</span><span class="p">,</span><span class="s">value</span><span class="p">,</span><span class="s">unit_id</span><span class="p">
</span></span></span><span class="line"><span class="cl"><span class="p"></span><span class="s">5441</span><span class="p">,</span><span class="s">95354</span><span class="p">,</span><span class="s">455</span><span class="p">,</span><span class="s">test Bauhinia</span><span class="p">,
</span></span></span></code></pre></div><p>2.2 Update the <code>production_like.pgdmp</code>, <a href="https://github.com/gigascience/gigadb-website/pull/548">PR548</a>
<code>ops/scripts/make_pgdmp_production_like.sh</code></p>
<h3 id="hints-from-rija">Hints from Rija<a hidden class="anchor" aria-hidden="true" href="#hints-from-rija">#</a></h3>
<blockquote>
<p>I must have forgotten what you said 😞
Right now I am working on to pass the <code>curation_log</code> test, here is my scenario:</p></blockquote>
<pre tabindex="0"><code>  Background:
    Given Gigadb web site is loaded with production-like data

   @wip @issue-#457 @javascript
    Scenario: Go to a non published dataset found in production-like database
        Given I sign in as an admin
        And I go to &#34;/adminFile/update/id/xxx&#34;
        And I should see some file attributes
        When I press &#34;Delete&#34;
        And I should not see file attributes
        And I go to &#34;dataset/YYY&#34;
        And I follow &#34;History&#34;
        Then I should not see some file attributes
</code></pre><blockquote>
<p>But I think the above scenario is not a proper way to test.
Because,  I could not identify the correct <code>xxx</code> and <code>YYY</code>. And even I found the <code>xxx</code>, this step <code>And I go to &quot;dataset/YYY&quot;</code> will not pass as error <code>The dataset does not exist</code> will be found.</p></blockquote>
<blockquote>
<p>So, can I have your suggestion on how to pass the <code>curation_log</code> test?</p></blockquote>
<hr>
<p>Among a dataset&rsquo;s attributes in the database table there are <code>id</code>, and <code>identifier</code>.</p>
<p>Controller actions that alter the dataset expect to have the internal id <code>id</code> as parameter (that&rsquo;s your xxx) as that&rsquo;s the most appropriate one to uniquely identify a row in a database table.</p>
<p>In <code>/adminFile/update/id/xxx</code>, <code>/id/</code> is how yii framework knows that we are looking for a dataset whose <code>id</code> attribute is <code>xxx</code></p>
<p><code>identifier</code> is for the DOI and is the public identifier for the dataset, that&rsquo;s why it is used in the view as the dataset url is meant to be shared publicly (that&rsquo;s your <code>yyy</code>).</p>
<p>So when you pick a dataset as example, select both attributes from the table.</p>
<pre tabindex="0"><code>gigadb=# select id, identifier, title from dataset;
id  | identifier |  title
...
 189 | 100133     | Reference data for phage M13 dsDNA generated with the Oxford Nanopore MinION.
 204 | 100143     | Software and supporting material for &#34;SMAP: a streamlined methylation pipelinefor bisulphite sequencing&#34;.
 210 | 100155     | Supporting data for &#34;Sparse whole-genome sequencing identifies two loci for major depressive disorder&#34;.
...
</code></pre><p>Regarding your second point: datasets that are not published cannot be accessible publicly, so going to the public url <code>/dataset/yyy</code> would result in that error.</p>
<p>You&rsquo;ve got couple of approaches:</p>
<p>You could add Given steps to change the upload status temporarily away from published, but then you would need to find a way to revert the change after the test has run.</p>
<p>Or you could have the Then steps to check this page:
(<a href="http://gigadb.gigasciencejournal.com:9170/datasetLog/admin/">http://gigadb.gigasciencejournal.com:9170/datasetLog/admin/</a>)
or more precisely manually navigate to the last page, and use that in a Then step.
It&rsquo;s not the most robust (the last page may change if we add/remove example datasets from production-like), but it&rsquo;s the easiest.</p>
<p>A better approach  is to use the test database instead of production-like then checking<code> /datasetLog/admin/</code>&rsquo;s first page would be enough, but you will need some Given steps to add some file attributes first to a dataset as I think the test database doesn&rsquo;t have any.</p>
<p>An improved alternative to that latter pre-condition would be to update the test data for the test database to have some file attributes in it so you don&rsquo;t have to add extra Given steps (I&rsquo;ve pasted bash code to do that easily in @pli888&rsquo;s PR 532, you&rsquo;d just have to update the corresponding CSV file beforehand)</p>
<h3 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h3>
<p><a href="https://travis-ci.com/kencho51/gigathing"><img alt="Build Status" loading="lazy" src="https://travis-ci.com/kencho51/gigathing.svg?branch=master"></a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://gigathing.pages.dev/tags/factory-method/">Factory Method</a></li>
      <li><a href="https://gigathing.pages.dev/tags/csv-migration/">Csv Migration</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://gigathing.pages.dev/css-works-in-chrome-but-not-safari/">
    <span class="title">« Prev</span>
    <br>
    <span>Why CSS works in Chrome but not Safari?</span>
  </a>
  <a class="next" href="https://gigathing.pages.dev/pass-behat-tests-example/">
    <span class="title">Next »</span>
    <br>
    <span>Pass Behat Tests Example</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "disqus_FHTaFcKzzy" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
        <span>kencho51</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
